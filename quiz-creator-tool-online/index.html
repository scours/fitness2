<!--
File: index.html
Contract: EU contract 2022-FR01-KA220-HED-000023509
Project: FitNESS 2 ERASMUS+
File Created: Thursday, 17th December 2020
Authors: Olivier VITRAC, Steward OUADI
-----
Last Modified: Tuesday, 21st May 2024
Modified By: Steward OUADI
-----
-->
<html>
<!-- Test for beginners - designed by Olivier Vitrac - rev. $ 2020-12-04 $ -->

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FITNESS Quizz</title>
  <link type="text/css" rel="stylesheet" href="src/quiz.css" />
</head>

<body>
  <div id="import-questions-div">
    <label for="fileInput" class="custom-file-label">Import questions</label>
    <input type="file" id="fileInput" accept=".md" onchange="convertQuestions()">
  </div>



  <!-- <button style="padding: 1px; position:unset;" onclick="convertQuestions()">Show questions</button> -->
  <pre id="output"></pre>
  <h1>
    <table>
      <tr>
        <td>
          <img src="src/Fitness2_logo.png" referrerpolicy="no-referrer" alt="FITNESS" title="ERASMUS+ Project" class=""
            width="128px" height="" />
        </td>
        <td>ERASMUS+ programme (contract 2022-FR01-KA220-HED-000023509)</td>
      </tr>
    </table>
  </h1>
  <div id="qbutton">
    <button id="previous"></button>
    <button id="next"></button>
    <button id="submit"></button>
  </div>
  <div id="results">
  </div>
  <div id="submit-results-proposal">
    <a href="#" id="submit-results">Share and see results. By clicking here, you agree to share your answers with the
      quiz creator in order to improve the platform</a>
  </div>
  <div class="quiz-container">
    <div id="quiz">
      <p>Click on the "Browse" button to import the Markdown file containing your questions and display them using the
        FITNESS quiz format.
      </p>
    </div>

  </div>


  <!-- Include libraries -->
  <script src="src/libraries/math.js" type="text/javascript"></script>
  <script src="src/utils.js" type="text/javascript"></script>

  <!-- Include classes -->
  <script src="src/GlobalSlide.js"></script>
  <script src="src/FillInTheBlanksSlide.js"></script>
  <script src="src/FreeWritingSlide.js"></script>
  <script src="src/RadioButtonQuizSlide.js"></script>
  <script src="src/SuggestionMenuSlide.js"></script>
  <script src="src/CheckBoxButtonQuizSlide.js"></script>
  <script src="src/ImageOnlySlide.js"></script>



  <!-- config.js: used to get configuration -->
  <!-- <script src="src/config.js"></script> -->
  <script type="text/javascript" src="src/beginner.js"></script>
  <script type="text/javascript" src="src/markdownContentVars.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>


  <script>
    let currentFilename = "";

    displaySendResultsByEmailButtonIfNecessary();

    function generateIdentifier() {
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var identifier = '';

      for (var i = 0; i < 5; i++) {
        var randomIndex = Math.floor(Math.random() * characters.length);
        identifier
          += characters.charAt(randomIndex);
      }
      return identifier;
    }

    const defaultSessionIdentifier = generateIdentifier();

    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      const queryParams = {};
      params.forEach((value, key) => {
        queryParams[key] = value;
      });
      return queryParams;
    }

    // Read the query parameters
    const queryParams = getQueryParams();


    // var markdownVariableToRead = window.location.hash.substring(1);
    var markdownVariableToRead = queryParams.quizId;
    var sessionId = queryParams.sessionId;

    console.log(queryParams);


    function questionsFromURL() {
      // If variable is not empty, use it to read markdown
      if (markdownVariableToRead.trim() !== "") {
        // Hide import questions div, as we won't need it
        var div = document.getElementById("import-questions-div");
        if (div) {
          div.style.display = "none";
        }

        var markdownContent = window[markdownVariableToRead];
        var lines = markdownContent.split('\n');
        var concatenatedLines = [];
        var currentLine = "";

        lines.forEach(line => {
          // Check if the line starts with a question indicator or configuration
          if (/^Q\d+:/.test(line) || /^canBeSentByEmail/.test(line)) {
            // If there's an ongoing question, push it to the array before starting a new one
            if (currentLine) {
              concatenatedLines.push(currentLine);
              currentLine = line;
            } else {
              currentLine = line;
            }
          } else {
            // Continue appending to current question
            currentLine += " " + line;
          }
        });

        // Don't forget to add the last processed line to the array
        if (currentLine) {
          concatenatedLines.push(currentLine);
        }

        processMarkdownContent(concatenatedLines);
      }
    }


    function convertQuestions() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a file');
        return;
      }

      currentFilename = file.name;

      const reader = new FileReader();
      reader.onload = (event) => {
        var lines = event.target.result.split('\n');
        processMarkdownContent(lines);
      };
      reader.readAsText(file);
    }

    function getConfigurationData(lines) {
      let isMultiChoice = false;
      let canBeSentByEmail = false;
      const configurationData = [];

      // Add the global configuration at the beginning
      configurationData.push({
        id: 'global',
        shuffleAnswers: false,
        currentScore: 0,
      });

      let currentQuestion = null;
      let answerIndex = 'a';
      let correctAnswer = [];

      lines.forEach((line) => {
        const trimmedLine = line.trim();

        if (trimmedLine.startsWith('canBeSentByEmail')) {
          canBeSentByEmail = trimmedLine.split(':')[1].trim() === "true";
        } else if (trimmedLine.match(/^Q(\d+)[\.:]?\s*(.*)/)) {
          if (isMultiChoice) {
            // Only include the correctAnswer array if there are correct answers
            if (correctAnswer.length > 0) {
              currentQuestion.correctAnswer = correctAnswer;
              configurationData.push(currentQuestion);
            }
          }

          const questionParts = trimmedLine.split(
            /(?<=^\S+)\s/); // Split at the first sequence of whitespace after non - whitespace
          const matchResult = questionParts[0].match(/^Q(\d+)[\.:]?\s*(.*)/);
          if (!matchResult) {
            console.error('Error: Unable to extract question number and text.');
            return;
          }
          const [, questionNumber,
            questionText
          ] = matchResult;
          let questionBody = questionText + (questionParts.length > 1 ? questionParts[1] :
            ""); // Include the rest of the line if exists

          if (questionBody.includes("BLANK")) {
            // Handle fill-in-the-blanks question
            const fillInTheBlanksSlide = new FillInTheBlanksSlide(questionBody);
            fillInTheBlanksSlide.id = 'fill-' + questionNumber;
            configurationData.push(fillInTheBlanksSlide);
            isMultiChoice = false; // Reset the multiChoice flag for the next question
          } else if (questionBody.includes("FREE WRITING")) {
            // Handle free writing question
            const freeWritingSlide = new FreeWritingSlide(questionBody);
            freeWritingSlide.id = "free-writing-" + questionNumber;
            configurationData.push(freeWritingSlide);
            isMultiChoice = false;
          } else {
            // Use regex to split the string at the first occurrence of " - [ ]" or " - [x]"
            let questionToDisplay = questionBody.split(/(?= - \[[x ]\])/)[0].trim();
            // Standard multiple-choice question handling
            currentQuestion = {
              id: 'quest-' + configurationData.length,
              question: {
                text: `Q${questionNumber}: ${questionToDisplay}`,
              },
              answers: {},
              minimumPassedScore: 0,
              pointsIfCorrectAnswer: 1,
              pointsIfWrongAnswer: 0,
            };
            isMultiChoice = true;
            answerIndex = 'a';
            correctAnswer = [];
            // Extract answers from the remaining part of the line
            if (questionParts.length > 1) {
              // This regex now correctly looks for the pattern " - [ ]" or " - [x]" to split the answers
              const answersParts = questionParts[1].split(/(?= - \[[x ]\])/);
              answersParts.forEach((part) => {
                // Trim and remove the leading " - [ ]" or " - [x]" from the answer text
                const match = part.match(/ - \[([ x])\](.*)/);
                if (match) {
                  const isCorrect = match[1] === 'x'; // Determine if the answer is marked as correct
                  const answerText = match[2].trim(); // Get the text part of the answer
                  currentQuestion.answers[answerIndex] = {
                    text: answerText,
                  };
                  if (isCorrect) {
                    correctAnswer.push(answerIndex);
                  }
                  answerIndex = String.fromCharCode(answerIndex.charCodeAt(0) +
                    1); // Increment to the next letter for answer index
                }
              });
            }

          }
        }
      });

      if (isMultiChoice && correctAnswer.length > 0) {
        // Only include the correctAnswer array if there are correct answers
        currentQuestion.correctAnswer = correctAnswer;
        configurationData.push(currentQuestion);
      }

      return {
        configurationData: configurationData,
        canBeSentByEmail: canBeSentByEmail
      };
    }


    function processMarkdownContent(lines) {
      const {
        configurationData,
        canBeSentByEmail
      } = getConfigurationData(lines);
      const quizContainer = document.getElementById("quiz");
      quizContainer.innerHTML = "";
      allSlides = configurationData;
      DoQuiz(canBeSentByEmail);
    }

    function camelCaseToWords(str) {
      return str.replace(/([a-z])([A-Z])/g, '$1 $2').toLowerCase();
    }

    // Generate the session identifier
    function generateSessionIdentifier() {
      return Math.random().toString(36).substring(2, 6).toUpperCase();
    }

    questionsFromURL();
    const webAppUrl =
      "https://script.google.com/macros/s/AKfycbyk2zFtF7CKPRwYnj_wAM__BL5Vrdt6bKUPHf0oh-PtzG8OoK4a-D2Bh-2zsxWYIMEU/exec";
    document.getElementById("submit-results").addEventListener("click", function () {
      event.preventDefault();
      console.log("button clicked")

      endedAt = new Date();
      // Define variables
      var recipient1 = "rotam@gmail.com";
      var title = markdownVariableToRead;
      var identifier = defaultSessionIdentifier;
      var subject = encodeURIComponent(title + "__" + identifier);
      console.log(questionsAndUserAnswers);
      var stringifiedContent = JSON.stringify(questionsAndUserAnswers, undefined, 2)
      var content = encodeURIComponent(stringifiedContent);

      // // Check if the current window is inside an iframe
      // if (window !== window.parent) {
      //   // Send the content to the parent window
      //   window.parent.postMessage({
      //     type: 'contentData',
      //     content: stringifiedContent
      //   }, 'https://fitness.agroparistech.fr/');
      // } else {
      //   // Handle standalone execution (if needed)
      //   console.log('Running as standalone page. Content:', stringifiedContent);
      // }

      // Calculate success rate and elapsed time
      var numberOfCorrectAnswersFixed = numberOfCorrectAnswers.toFixed(2);
      var numberOfQuestions = visitedQuestions.size;
      var successRate = ((numberOfCorrectAnswersFixed / numberOfQuestions) * 100).toFixed(2) + '%';
      var elapsedTime = new Date(endedAt - startedAt).toISOString().substr(11, 8);


      let learnerData;
      const encodedLearnerData = localStorage.getItem("learnerData");

      if (encodedLearnerData) {
        // Decode and decompress the data
        const decompressedLearnerData =
          LZString.decompressFromEncodedURIComponent(encodedLearnerData);

        if (decompressedLearnerData) {
          // Parse the JSON string back to an object
          learnerData = JSON.parse(decompressedLearnerData);

          // // Set values to input fields if they exist and the elements are available in the DOM
          // const firstNameElement = document.getElementById("firstName");
          // const lastNameElement = document.getElementById("lastName");
          // const emailElement = document.getElementById("email");

          // if (firstNameElement && learnerData.FirstName)
          //   firstNameElement.value = learnerData.FirstName;
          // if (lastNameElement && learnerData.LastName)
          //   lastNameElement.value = learnerData.LastName;
          // if (emailElement && learnerData.Email) emailElement.value = learnerData.Email;




          // console.log("Data retrieved from local storage - Quiz creator tool:", learnerData);
          // console.log("Stringified content:", stringifiedContent);
        }
      }

      const quizUrl =
        `https://fitness.agroparistech.fr/fitness2/lectures/quiz-creator-tool-online/index.html#${markdownVariableToRead}`

      // Get the quiz identifier from the markdown variable and limit it to 30 characters
      var quizIdentifier = camelCaseToWords(markdownVariableToRead).slice(0, 30);



      // Format the current date for the sheet name
      var currentDate = new Date();
      var formattedDate = currentDate.toLocaleDateString('en-GB').split('/').reverse().join(
        '/'); // Format: DD/MM/YY

      // Create the sheet name
      var sheetName = `${formattedDate} ${quizIdentifier} ${sessionId}`;

      if (!learnerData) {
        learnerData = {
          FirstName: "unknown",
          LastName: "unknown",
          Email: "unknown"
        };
      }

      const metadata = {
        name: markdownVariableToRead,
        mailRecipient: recipient1,
        numberOfCorrectAnswers: numberOfCorrectAnswersFixed,
        numberOfQuestions: numberOfQuestions,
        successRate: successRate,
        elapsedTime: elapsedTime,
        quizUrl: quizUrl,
        startedAt: startedAt,
        endedAt: endedAt,
        sheetName: sheetName,
        sessionIdentifier: sessionId,
      };
      const quizInfo = {
        learnerData,
        questionsAndUserAnswers,
        metadata
      }



      console.log("Stringified content:", quizInfo);

      // Convert the data object to JSON string
      const quizInfoStringified = JSON.stringify(quizInfo);

      // Compress and encode the JSON string
      const compressedQuizInfo = LZString.compressToEncodedURIComponent(quizInfoStringified);

      // const URLWithQuizInfo =
      // `https://fitness.agroparistech.fr/fitness2/lectures/quiz-creator-tool-online/quiz-results.html#${compressedQuizInfo}`

      const URLWithQuizInfo =
        `http://127.0.0.1:5502/quiz-creator-tool-online/quiz-results.html#${compressedQuizInfo}`;



      let bodyToSend = JSON.stringify({
        url: URLWithQuizInfo,
        sheetId: '1tzrLootQ-mFCjg6XHqW5tPd39gKl92Z_ldMK2gQNyPI', // Assuming this will come from somewhere
        sheetName: sheetName,
        quizIdentifier: quizIdentifier,
        successRate: successRate,
        elapsedTime: elapsedTime,
        firstName: learnerData.FirstName,
        lastName: learnerData.LastName,
        email: learnerData.Email
      });

      console.log("body to send:", bodyToSend)

      // Apps Script web app URL
      // Send URLWithQuizInfo to Google Apps Script web app
      fetch(webAppUrl, {
          redirect: "follow",
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8',
          },
          body: bodyToSend,
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.status === "success") {
            console.log('Server response:', data);
            alert('Results successfully shared.');
          } else {
            throw new Error(`Server error: ${data.message}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error saving URL to Google Sheets.');
        });

      // Create the div and input elements dynamically
      var contentDiv = document.createElement("div");
      var inputLabel = document.createElement("label");
      inputLabel.setAttribute("for", "input-id");
      inputLabel.innerHTML = "This is your result URL. Open it or share it with anyone";

      var inputField = document.createElement("input");
      inputField.type = "text";
      inputField.id = "input-id";
      // inputField.value = defaultSessionIdentifier;
      inputField.value = URLWithQuizInfo;

      // Make the input field bigger
      inputField.style.fontSize = '1.5em'; // Increases the font size
      // inputField.style.height = '50px'; // Sets a specific height
      inputField.style.width = '60%'; // Sets the width to 100% of its container
      inputField.style.padding = '10px'; // Adds some padding inside the input box for better text visibility

      var sendButton = document.createElement("button");
      sendButton.id = "btn-send";
      sendButton.textContent = "Open";

      var downloadText = document.createElement("p");
      downloadText.innerHTML =
        "";
      var sendButtonExplainer = document.createElement("p");
      sendButtonExplainer.innerHTML =
        "";

      // Append elements to the contentDiv
      contentDiv.appendChild(inputLabel);
      contentDiv.appendChild(inputField);
      contentDiv.appendChild(sendButton);
      contentDiv.appendChild(sendButtonExplainer);
      contentDiv.appendChild(downloadText);

      // Append contentDiv to the document, just after the submit-results button
      var submitButton = document.getElementById("submit-results");
      submitButton.parentNode.insertBefore(contentDiv, submitButton.nextSibling);

      // Add click event listener to the send button
      sendButton.addEventListener("click", function () {
        // var sessionIdentifier = inputField.value;
        // var mailtoLink = "mailto:" + recipient1 + "?subject=" + subject + "&body=" + content;
        // window.location.href = mailtoLink;
        window.open(URLWithQuizInfo, '_blank');
      });

      // Add click event listener to the download link
      document.getElementById("download-link").addEventListener("click", function (e) {
        e.preventDefault();

        // Sanitize the subject to make it a valid filename.
        // This basic example replaces characters not typically allowed or recommended in filenames.
        let filename = subject.replace(/[<>:"\/\\|?*\x00-\x1F]/g, '_') + ".txt";

        download(filename, decodeURIComponent(content));


      });

      function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      }
    });
  </script>




</body>

</html>