<!--
File: quiz-results.html
Contract: EU contract 2022-FR01-KA220-HED-000023509
Project: FitNESS 2 ERASMUS+
File Created: Tuesday, 14th May 2024
Authors: Steward OUADI (AgroParisTech),  Olivier VITRAC (INRAE)
-----
Last Modified: Saturday, 21st September 2024
Modified By: Steward OUADI
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FITNESS Quiz Results</title>
  <link rel="stylesheet" href="https://fitness.agroparistech.fr/fitness2/lectures/src/css/font-awesome-4-7-0.min.css">
  <link href="https://fitness.agroparistech.fr/fitness2/lectures/src/css/fitness.css" rel="stylesheet">
  <link href="https://fitness.agroparistech.fr/fitness2/lectures/src/css/fitness2.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="src/lecturesDataContent.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .section h2 {
      margin-top: 0;
    }

    .question {
      margin-bottom: 10px;
    }

    .choices {
      margin-left: 20px;
    }

    .correct {
      color: green;
    }

    .incorrect {
      color: red;
    }

    /* New CSS for enhanced visual separation and clarity */
    #questionsContainer {
      display: flex;
      flex-direction: column;
      gap: 20px;
      /* Space between each question block */
    }

    .question-block {
      border: 2px solid #ddd;
      /* Light gray border */
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
      /* Light background */
    }


    .question-text {
      font-weight: bold;
      color: #333;
      /* Darker color for questions */
    }

    .correct-answer,
    .user-answer {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .correct-answer {
      background-color: #c8e6c9;
      /* Light green for correct answers */
    }

    .incorrect-answer {
      background-color: #ffcdd2;
      /* Light red for incorrect answers */
    }

    ul.choices {
      margin-top: 10px;
      padding-left: 20px;
    }

    h3 {
      margin-top: 0;
      font-size: 1.2em;
      color: #00796b;
      /* Distinctive header color */
    }
  </style>

</head>

<body>
  <main-header></main-header>

  <div class="container">
    <div class="section">
      <h2>Learner Information</h2>
      <p id="learnerName"></p>
      <p id="learnerEmail"></p>
    </div>
    <div class="section">
      <h2>Quiz Information</h2>
      <p><a id="lectureURL" href="#" target="_blank"></a></p>
      <p><a id="quizURL" href="#" target="_blank"></a></p>
      <p id="successPercentage"></p>
      <p id="startedAt"></p>
      <p id="endedAt"></p>
      <p id="elapsedTime"></p>
      <!-- <div class="section"> -->
      <h2>Questions and Answers</h2>
      <div id="questionsContainer"></div>
      <!-- </div> -->
      <!-- Hide graph for now, as we don't need it right now -->
      <!-- <div class="section">
        <h2>Score Graph</h2>
        <div id="scoreChart"></div>
        <p id="participantsCount"></p>
      </div> -->
    </div>
    <!-- <div class="section">
      <h2>Elapsed Time Graph</h2>
      <div id="elapsedTimeChart"></div>
    </div> -->
  </div>

  <script>
    const sheetId = '1tzrLootQ-mFCjg6XHqW5tPd39gKl92Z_ldMK2gQNyPI'; // Add your sheetId here
    const webAppUrl =
      'https://script.google.com/macros/s/AKfycbyk2zFtF7CKPRwYnj_wAM__BL5Vrdt6bKUPHf0oh-PtzG8OoK4a-D2Bh-2zsxWYIMEU/exec';

    // Function to fetch data from Google Sheets and draw the score chart
    function drawScoreChart(sheetName) {
      // Fetch data from the Google Sheets and update the chart
      fetch(`${webAppUrl}?sheetId=${sheetId}&sheetName=${sheetName}`)
        .then(response => response.json())
        .then(data => {
          const scores = data.map(row => parseFloat(row['Success rate (percentage)'].replace('%', '')));
          const averageScore = calculateAverage(scores);
          const medianScore = calculateMedian(scores);

          const dataTable = google.visualization.arrayToDataTable([
            ['Metric', 'Value'],
            ['Average Score (%)', averageScore],
            ['Median Score (%)', medianScore]
          ]);

          const options = {
            title: 'Quiz Scores',
            vAxis: {
              title: 'Percentage (%)'
            },
            width: 600,
            height: 400
          };

          const chart = new google.visualization.ColumnChart(document.getElementById('scoreChart'));
          chart.draw(dataTable, options);

          // Display the number of participants
          document.getElementById('participantsCount').textContent = `Number of participants: ${scores.length}`;
        })
        .catch(error => console.error('Error fetching score data:', error));
    }

    // Function to fetch data from Google Sheets and draw the elapsed time chart
    function drawElapsedTimeChart(sheetName) {
      // Fetch data from the Google Sheets and update the chart
      fetch(`${webAppUrl}?sheetId=${sheetId}&sheetName=${sheetName}`)
        .then(response => response.json())
        .then(data => {
          const elapsedTimes = data.map(row => {
            const timeParts = row['Elapsed Time'].split(':');
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            const seconds = parseInt(timeParts[2], 10);
            return hours * 3600 + minutes * 60 + seconds;
          });

          const averageElapsedTime = calculateAverage(elapsedTimes);
          const medianElapsedTime = calculateMedian(elapsedTimes);

          const averageElapsedTimeFormatted = formatSecondsToHMS(averageElapsedTime);
          const medianElapsedTimeFormatted = formatSecondsToHMS(medianElapsedTime);

          const dataTable = google.visualization.arrayToDataTable([
            ['Metric', 'Value'],
            ['Average Elapsed Time (hh:mm:ss)', {
              v: averageElapsedTime,
              f: averageElapsedTimeFormatted
            }],
            ['Median Elapsed Time (hh:mm:ss)', {
              v: medianElapsedTime,
              f: medianElapsedTimeFormatted
            }]
          ]);

          const options = {
            title: 'Elapsed Time',
            vAxis: {
              title: 'Time (hh:mm:ss)'
            },
            width: 600,
            height: 400
          };

          // const chart = new google.visualization.ColumnChart(document.getElementById('elapsedTimeChart'));
          // chart.draw(dataTable, options);
        })
        .catch(error => console.error('Error fetching elapsed time data:', error));
    }

    // Helper function to format seconds into hh:mm:ss
    function formatSecondsToHMS(seconds) {
      const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
      const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Function to calculate the average of an array of numbers
    function calculateAverage(data) {
      const sum = data.reduce((acc, value) => acc + value, 0);
      return sum / data.length;
    }

    // Function to calculate the median of an array of numbers
    function calculateMedian(data) {
      data.sort((a, b) => a - b);
      const middleIndex = Math.floor(data.length / 2);
      if (data.length % 2 === 0) {
        return (data[middleIndex - 1] + data[middleIndex]) / 2;
      } else {
        return data[middleIndex];
      }
    }

    function drawCharts(sheetName) {
      drawScoreChart(sheetName);
      // drawElapsedTimeChart(sheetName);
    }

    // Function to compare the expected and user answers correctly
    function compareAnswers(correctAnswer, userAnswer) {
      // Ensure correctAnswer and userAnswer are strings before splitting
      const correctStr = typeof correctAnswer === 'string' ? correctAnswer : String(correctAnswer);
      const userStr = typeof userAnswer === 'string' ? userAnswer : String(userAnswer);

      const correctArray = correctStr.split(',').map(item => item.trim()).sort();
      const userArray = userStr.split(',').map(item => item.trim()).sort();

      return JSON.stringify(correctArray) === JSON.stringify(userArray);
    }


    document.addEventListener('DOMContentLoaded', function () {
      // Get the hash part of the URL, which contains the compressedQuizInfo
      const hash = window.location.hash.substring(1);

      if (hash) {
        // Decompress the hash value
        const decompressedQuizInfo = LZString.decompressFromEncodedURIComponent(hash);
        if (decompressedQuizInfo) {
          // Parse the decompressed string to an object
          const quizInfo = JSON.parse(decompressedQuizInfo);

          // Display learner information
          const learnerData = quizInfo.learnerData;
          document.getElementById('learnerName').textContent =
            `Name: ${learnerData.FirstName} ${learnerData.LastName}`;
          document.getElementById('learnerEmail').textContent = `Email: ${learnerData.Email}`;

          // Display quiz information
          const metadata = quizInfo.metadata;

          // Assuming quizInfo.metadata.name corresponds to lecturesData.id
          const lectureId = quizInfo.metadata.name;

          // Find the lecture data that matches the given id
          const lectureData = lecturesData.find(lecture => lecture.id === lectureId);

          if (lectureData) {
            // Set the text content for the lecture URL
            document.getElementById('lectureURL').textContent = `Access the lecture "${lectureData.name}" by clicking
          here`;

            // Set the href attribute for the lecture URL
            document.getElementById('lectureURL').href = lectureData.url;
          } else {
            // Handle the case where the lecture data is not found (optional)
            console.error(`Lecture with ID "${lectureId}" not found in lecturesData.`);
          }

          document.getElementById('quizURL').textContent = "Access the quiz by clicking here";
          document.getElementById('quizURL').href = metadata.quizUrl;
          const numberOfCorrectAnswers = parseFloat(metadata.numberOfCorrectAnswers);
          const numberOfQuestions = parseInt(metadata.numberOfQuestions);
          const successPercentage = ((numberOfCorrectAnswers / numberOfQuestions) * 100).toFixed(2);
          document.getElementById('successPercentage').textContent = `Success Percentage: ${successPercentage}%`;
          let sheetName = metadata.sheetName;

          // Load the Google Charts library
          google.charts.load('current', {
            'packages': ['corechart']
          });
          google.charts.setOnLoadCallback(() => drawCharts(sheetName));

          // Set an interval to update the charts every 5 seconds
          setInterval(() => drawCharts(sheetName), 5000);

          // Display startedAt and endedAt with separate date and time including the weekday
          const startedAt = new Date(metadata.startedAt);
          const endedAt = new Date(metadata.endedAt);

          // Options to include the weekday in the date string
          const dateOptions = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          };

          // Format the start and end times
          const startedAtTime = startedAt.toLocaleTimeString();
          const startedAtDate = startedAt.toLocaleDateString(undefined, dateOptions);
          const endedAtTime = endedAt.toLocaleTimeString();
          const endedAtDate = endedAt.toLocaleDateString(undefined, dateOptions);

          document.getElementById('startedAt').textContent =
            `Quiz Started At: ${startedAtTime}, on ${startedAtDate}`;
          document.getElementById('endedAt').textContent = `Quiz Ended At: ${endedAtTime}, on ${endedAtDate}`;

          // Calculate and display elapsed time
          const elapsedTime = endedAt - startedAt;
          const elapsedHours = Math.floor(elapsedTime / (1000 * 60 * 60));
          const elapsedMinutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
          const elapsedSeconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);
          document.getElementById('elapsedTime').textContent =
            `Elapsed Time: ${elapsedHours}h ${elapsedMinutes}m ${elapsedSeconds}s`;

          // Display questions and answers
          const questionsContainer = document.getElementById('questionsContainer');
          quizInfo.questionsAndUserAnswers.forEach((q, index) => {
            // Create a div for each question block
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-block'; // Apply the new class for visual separation

            // Adding a header for the question block with numbering
            const questionHeader = document.createElement('h3');
            questionHeader.textContent = `Question ${index + 1}`;
            questionDiv.appendChild(questionHeader);

            if (q.currentSlide) {
              // Handle currentSlide type
              const questionText = document.createElement('p');
              questionText.className = 'question-text'; // Apply the new class for question text
              questionText.textContent = `${q.currentSlide.question.text}`;
              questionDiv.appendChild(questionText);

              const choicesList = document.createElement('ul');
              choicesList.className = 'choices';
              for (const [key, answer] of Object.entries(q.currentSlide.answers)) {
                const choiceItem = document.createElement('li');
                choiceItem.textContent = `${key}: ${answer.text}`;
                choicesList.appendChild(choiceItem);
              }
              questionDiv.appendChild(choicesList);

              const correctAnswer = document.createElement('p');
              correctAnswer.className = 'correct-answer'; // Class for correct answer style
              correctAnswer.textContent = `Expected Answer: ${q.currentSlide.correctAnswer}`;
              questionDiv.appendChild(correctAnswer);

              const userAnswer = document.createElement('p');
              // Use compareAnswers function to determine if the user's answer is correct
              userAnswer.className = compareAnswers(q.currentSlide.correctAnswer, q.userAnswer) ? 'correct' :
                'incorrect';
              userAnswer.textContent = `Your Answer: ${q.userAnswer}`;
              questionDiv.appendChild(userAnswer);
            } else if (q.slideToRegister) {
              // Handle slideToRegister type, showing only questionText and userAnswer
              const questionText = document.createElement('p');
              questionText.className = 'question-text'; // Use the same class for consistency
              questionText.textContent = `${q.slideToRegister.questionText}`;
              questionDiv.appendChild(questionText);

              const userAnswer = document.createElement('p');
              userAnswer.className = 'user-answer'; // Class for user answer style
              userAnswer.textContent = `Your Answer: ${q.userAnswer}`;
              questionDiv.appendChild(userAnswer);
            }

            // Append the question block to the main container
            questionsContainer.appendChild(questionDiv);
          });



        } else {
          console.error('Failed to decompress quiz information.');
        }
      } else {
        console.error('No quiz information found in the URL.');
      }
    });
  </script>
  <main-footer></main-footer>

  <link rel="stylesheet" href="../lectures/modifyLectures/assets/bootstrap/css/bootstrap.min.css" />
  <script src="../lectures/src/js/google_translate_plugin.js"></script>
  <script src="../lectures/src/js/header.js"></script>
  <script src="../lectures/src/js/footer.js"></script>
</body>

</html>